<ion-header class="ion-no-border">
  <ion-toolbar class="auth-toolbar">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/"></ion-back-button>
    </ion-buttons>
    <ion-title>Cambiar contraseña</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="auth-content" [fullscreen]="true">
  <div style="display:flex;justify-content:center;align-items:flex-start;padding:24px 16px;min-height:100%;">
    <div style="width:100%;max-width:460px;">

      <ion-card class="auth-card">
        <ion-card-header>
          <h2 class="auth-title font-display">Cambiar contraseña</h2>
          <p class="auth-subtitle">Ingresa tu contraseña actual y elige una nueva.</p>
        </ion-card-header>

        <ion-card-content>

          <!-- Banner de error -->
          @if (error()) {
            <div class="cs-error-banner">
              <ion-icon name="alert-circle-outline" style="font-size:18px;flex-shrink:0;"></ion-icon>
              <span>{{ error() }}</span>
            </div>
          }

          <form [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>

            <!-- Contraseña actual -->
            <ion-item
              class="cs-item"
              [class.item-invalid]="actualCtrl.invalid && actualCtrl.touched"
              lines="none"
            >
              <ion-icon name="lock-closed-outline" slot="start" color="medium"></ion-icon>
              <ion-label position="stacked">Contraseña actual</ion-label>
              <ion-input
                [type]="showActual() ? 'text' : 'password'"
                formControlName="passwordActual"
                placeholder="Tu contraseña actual"
                autocomplete="current-password"
              ></ion-input>
              <ion-button
                slot="end" fill="clear" size="small"
                (click)="toggleShowActual()"
                [attr.aria-label]="showActual() ? 'Ocultar' : 'Mostrar'"
              >
                <ion-icon [name]="showActual() ? 'eye-off-outline' : 'eye-outline'" color="medium"></ion-icon>
              </ion-button>
            </ion-item>
            @if (actualCtrl.invalid && actualCtrl.touched) {
              <p class="cs-error-msg">
                <ion-icon name="alert-circle-outline"></ion-icon>
                La contraseña actual es obligatoria.
              </p>
            }

            <!-- Nueva contraseña -->
            <ion-item
              class="cs-item"
              [class.item-invalid]="nuevaCtrl.invalid && nuevaCtrl.touched"
              lines="none"
              style="margin-top:8px;"
            >
              <ion-icon name="lock-open-outline" slot="start" color="medium"></ion-icon>
              <ion-label position="stacked">Nueva contraseña</ion-label>
              <ion-input
                [type]="showNueva() ? 'text' : 'password'"
                formControlName="passwordNueva"
                placeholder="Mínimo 8 caracteres"
                autocomplete="new-password"
              ></ion-input>
              <ion-button
                slot="end" fill="clear" size="small"
                (click)="toggleShowNueva()"
                [attr.aria-label]="showNueva() ? 'Ocultar' : 'Mostrar'"
              >
                <ion-icon [name]="showNueva() ? 'eye-off-outline' : 'eye-outline'" color="medium"></ion-icon>
              </ion-button>
            </ion-item>
            @if (nuevaCtrl.invalid && nuevaCtrl.touched) {
              <p class="cs-error-msg">
                <ion-icon name="alert-circle-outline"></ion-icon>
                @if (nuevaCtrl.errors?.['required']) { La nueva contraseña es obligatoria. }
                @else { Mínimo 8 caracteres. }
              </p>
            }

            <!-- Confirmar contraseña -->
            <ion-item
              class="cs-item"
              [class.item-invalid]="(confirmarCtrl.invalid && confirmarCtrl.touched) || mismatch"
              lines="none"
              style="margin-top:8px;"
            >
              <ion-icon name="lock-open-outline" slot="start" color="medium"></ion-icon>
              <ion-label position="stacked">Confirmar nueva contraseña</ion-label>
              <ion-input
                [type]="showConfirm() ? 'text' : 'password'"
                formControlName="confirmarPassword"
                placeholder="Repite la nueva contraseña"
                autocomplete="new-password"
              ></ion-input>
              <ion-button
                slot="end" fill="clear" size="small"
                (click)="toggleShowConfirm()"
                [attr.aria-label]="showConfirm() ? 'Ocultar' : 'Mostrar'"
              >
                <ion-icon [name]="showConfirm() ? 'eye-off-outline' : 'eye-outline'" color="medium"></ion-icon>
              </ion-button>
            </ion-item>
            @if (confirmarCtrl.invalid && confirmarCtrl.touched) {
              <p class="cs-error-msg">
                <ion-icon name="alert-circle-outline"></ion-icon>
                La confirmación es obligatoria.
              </p>
            } @else if (mismatch) {
              <p class="cs-error-msg">
                <ion-icon name="alert-circle-outline"></ion-icon>
                Las contraseñas no coinciden.
              </p>
            }

            <!-- Botón submit -->
            <ion-button
              class="cs-btn-primary"
              expand="block"
              type="submit"
              [disabled]="form.invalid || loading()"
              style="margin-top:16px;"
            >
              @if (loading()) {
                <ion-spinner name="crescent" slot="start"></ion-spinner>
                Actualizando...
              } @else {
                Cambiar contraseña
              }
            </ion-button>

          </form>

        </ion-card-content>
      </ion-card>

    </div>
  </div>
</ion-content>
