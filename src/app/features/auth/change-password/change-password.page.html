<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home" text=""></ion-back-button>
    </ion-buttons>
    <ion-title>Cambiar Contraseña</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="mx-auto max-w-sm px-6 py-8">

    <!-- Description -->
    <div class="mb-6">
      <p class="text-sm text-gray-500">
        Ingresa tu contraseña actual y la nueva contraseña (mínimo 8 caracteres).
      </p>
    </div>

    <!-- Error -->
    @if (errorMessage()) {
      <div class="mb-4 rounded-lg bg-red-50 p-3">
        <ion-text color="danger">
          <p class="text-sm">{{ errorMessage() }}</p>
        </ion-text>
      </div>
    }

    <div class="rounded-2xl bg-white p-6 shadow-md">
      <form [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>

        <!-- Show/hide toggle -->
        <div class="mb-4 flex items-center justify-end gap-2">
          <ion-button fill="clear" size="small" (click)="togglePasswords()" type="button">
            <ion-icon [name]="showPasswords() ? 'eye-off-outline' : 'eye-outline'" slot="start"></ion-icon>
            {{ showPasswords() ? 'Ocultar' : 'Mostrar' }} contraseñas
          </ion-button>
        </div>

        <!-- Contraseña actual -->
        <div class="mb-4">
          <ion-item lines="full" [class.ion-invalid]="f.passwordActual.touched && f.passwordActual.invalid">
            <ion-icon name="lock-closed-outline" slot="start" color="medium"></ion-icon>
            <ion-label position="floating">Contraseña actual</ion-label>
            <ion-input
              [type]="showPasswords() ? 'text' : 'password'"
              formControlName="passwordActual"
              autocomplete="current-password"
            ></ion-input>
          </ion-item>
          @if (f.passwordActual.touched && f.passwordActual.hasError('required')) {
            <p class="error-message">La contraseña actual es requerida.</p>
          }
        </div>

        <!-- Contraseña nueva -->
        <div class="mb-4">
          <ion-item lines="full" [class.ion-invalid]="f.passwordNueva.touched && f.passwordNueva.invalid">
            <ion-icon name="lock-closed-outline" slot="start" color="medium"></ion-icon>
            <ion-label position="floating">Nueva contraseña</ion-label>
            <ion-input
              [type]="showPasswords() ? 'text' : 'password'"
              formControlName="passwordNueva"
              autocomplete="new-password"
            ></ion-input>
          </ion-item>
          @if (f.passwordNueva.touched && f.passwordNueva.hasError('required')) {
            <p class="error-message">La nueva contraseña es requerida.</p>
          }
          @if (f.passwordNueva.touched && f.passwordNueva.hasError('minlength')) {
            <p class="error-message">Mínimo 8 caracteres.</p>
          }
        </div>

        <!-- Confirmar contraseña -->
        <div class="mb-6">
          <ion-item
            lines="full"
            [class.ion-invalid]="f.confirmarPassword.touched && (f.confirmarPassword.invalid || form.hasError('passwordMismatch'))"
          >
            <ion-icon name="lock-closed-outline" slot="start" color="medium"></ion-icon>
            <ion-label position="floating">Confirmar nueva contraseña</ion-label>
            <ion-input
              [type]="showPasswords() ? 'text' : 'password'"
              formControlName="confirmarPassword"
              autocomplete="new-password"
            ></ion-input>
          </ion-item>
          @if (f.confirmarPassword.touched && form.hasError('passwordMismatch')) {
            <p class="error-message">Las contraseñas no coinciden.</p>
          }
        </div>

        <ion-button
          expand="block"
          type="submit"
          [disabled]="form.invalid || loading()"
        >
          @if (loading()) {
            <ion-spinner name="crescent" class="mr-2"></ion-spinner>
          }
          Actualizar Contraseña
        </ion-button>

      </form>
    </div>

  </div>
</ion-content>
