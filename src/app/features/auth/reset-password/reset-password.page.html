<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Nueva Contraseña</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="mx-auto max-w-sm px-6 py-8">

    <!-- Token inválido o expirado -->
    @if (invalidToken()) {
      <div class="rounded-2xl bg-white p-6 shadow-md text-center">
        <div class="mb-4 flex justify-center">
          <div class="flex h-16 w-16 items-center justify-center rounded-full bg-red-100">
            <ion-icon name="lock-closed-outline" class="text-3xl text-red-500"></ion-icon>
          </div>
        </div>
        <h2 class="mb-2 text-lg font-semibold text-gray-800">Enlace inválido o expirado</h2>
        <p class="mb-6 text-sm text-gray-500 leading-relaxed">
          Este enlace de recuperación no es válido o ya expiró. Los enlaces son válidos por 30 minutos.
        </p>
        <ion-button expand="block" routerLink="/auth/forgot-password">
          Solicitar nuevo enlace
        </ion-button>
      </div>
    }

    <!-- Formulario -->
    @if (!invalidToken()) {
      <div class="mb-6">
        <p class="text-sm text-gray-500 leading-relaxed">
          Ingresa tu nueva contraseña. Debe tener al menos 8 caracteres.
        </p>
      </div>

      @if (errorMessage()) {
        <div class="mb-4 rounded-lg bg-red-50 p-3">
          <ion-text color="danger">
            <p class="text-sm">{{ errorMessage() }}</p>
          </ion-text>
        </div>
      }

      <div class="rounded-2xl bg-white p-6 shadow-md">
        <form [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>

          <!-- Show/hide toggle -->
          <div class="mb-4 flex items-center justify-end gap-2">
            <ion-button fill="clear" size="small" (click)="togglePasswords()" type="button">
              <ion-icon [name]="showPasswords() ? 'eye-off-outline' : 'eye-outline'" slot="start"></ion-icon>
              {{ showPasswords() ? 'Ocultar' : 'Mostrar' }} contraseñas
            </ion-button>
          </div>

          <!-- Nueva contraseña -->
          <div class="mb-4">
            <ion-item lines="full" [class.ion-invalid]="f.nuevaPassword.touched && f.nuevaPassword.invalid">
              <ion-icon name="lock-closed-outline" slot="start" color="medium"></ion-icon>
              <ion-label position="floating">Nueva contraseña</ion-label>
              <ion-input
                [type]="showPasswords() ? 'text' : 'password'"
                formControlName="nuevaPassword"
                autocomplete="new-password"
              ></ion-input>
            </ion-item>
            @if (f.nuevaPassword.touched && f.nuevaPassword.hasError('required')) {
              <p class="error-message">La contraseña es requerida.</p>
            }
            @if (f.nuevaPassword.touched && f.nuevaPassword.hasError('minlength')) {
              <p class="error-message">Mínimo 8 caracteres.</p>
            }
          </div>

          <!-- Confirmar contraseña -->
          <div class="mb-6">
            <ion-item
              lines="full"
              [class.ion-invalid]="f.confirmarPassword.touched && (f.confirmarPassword.invalid || form.hasError('passwordMismatch'))"
            >
              <ion-icon name="lock-closed-outline" slot="start" color="medium"></ion-icon>
              <ion-label position="floating">Confirmar contraseña</ion-label>
              <ion-input
                [type]="showPasswords() ? 'text' : 'password'"
                formControlName="confirmarPassword"
                autocomplete="new-password"
              ></ion-input>
            </ion-item>
            @if (f.confirmarPassword.touched && form.hasError('passwordMismatch')) {
              <p class="error-message">Las contraseñas no coinciden.</p>
            }
          </div>

          <ion-button
            expand="block"
            type="submit"
            [disabled]="form.invalid || loading()"
          >
            @if (loading()) {
              <ion-spinner name="crescent" class="mr-2"></ion-spinner>
            }
            Restablecer contraseña
          </ion-button>

        </form>
      </div>
    }

  </div>
</ion-content>
